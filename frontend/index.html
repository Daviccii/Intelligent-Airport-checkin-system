<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFly - Intelligent Airport System</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Toast and Modal Styles -->
    <style>
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            margin-bottom: 10px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.success { background-color: #4caf50; }
        .toast.error { background-color: #f44336; }
        .toast.info { background-color: #2196f3; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .action-panel {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .action-panel.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
    
</head>
<body>
    <nav class="main-nav">
        <div class="container nav-container">
            <div class="logo-container">
                <div class="logo">
                    <!-- simple plane icon -->
                    <svg viewBox="0 0 24 24">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>
                <h2 class="logo-text">SmartFly</h2>
            </div>
            <div class="nav-links">
                <a href="/" class="active">Home</a>
                <a href="/checkin.html">Check-In</a>
                <a href="/lookup.html">My Bookings</a>
                <a href="/flight-results.html">Flights</a>
                <!-- theme toggle is provided by the shared header fragment -->
                <a href="/admin/dashboard.html" class="btn login-btn">Admin</a>
            </div>
        </div>
    </nav>


    <main>
    <style>
        /* Hero Section */
        .hero-section {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), 
                        url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 80px 20px;
            margin: -30px -30px 30px;
            border-radius: 8px;
            text-align: center;
        }

        .hero-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-content h2 {
            font-size: 3.5em;
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero-content p {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .action-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: 1px solid #eee;
        }

        .action-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-color, #007bff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }

        .action-icon svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        /* Features Section */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .feature-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            background: var(--accent-color, #17a2b8);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .feature-icon svg {
            width: 35px;
            height: 35px;
            fill: white;
        }

        .feature-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
        }

        /* Latest Offers Section */
        .offers-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 40px;
            border-radius: 15px;
            margin: 40px 0;
        }

        .offers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .offer-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .offer-tag {
            position: absolute;
            top: 15px;
            right: -30px;
            background: var(--accent-color, #17a2b8);
            color: white;
            padding: 5px 30px;
            transform: rotate(45deg);
            font-size: 0.8em;
        }

        /* Panel Styles */
        .action-panel {
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        /* Form Styles */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 500;
            color: #333;
        }

        .input-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Table Styles */
        .pass-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .pass-table th,
        .pass-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .pass-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .pass-table tr:hover {
            background: #f8f9fa;
        }

        /* Card Styles */
        .card {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .card p {
            margin: 5px 0;
            color: #666;
        }

        /* Message Styles */
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .empty {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        @media (max-width: 768px) {
            .form-group {
                padding: 0 15px;
            }
            
            .card {
                margin: 10px;
            }
            
            .action-panel {
                padding: 15px;
            }

            .hero-content h2 {
                font-size: 2.5em;
            }

            .hero-section {
                padding: 40px 15px;
            }

            .offers-section {
                padding: 20px;
            }
        }

        /* Enhanced Button Styles */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn.primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
        }

        /* Passenger Wizard Steps */
        #steps {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }

        #steps .step {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            text-align: center;
            background: #f5f5f5;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        #steps .step:not([style*="cursor: not-allowed"]):hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        #steps .step.active {
            background: var(--primary-color, #007bff);
            color: white;
            font-weight: bold;
        }

        #steps .step[style*="cursor: not-allowed"] {
            background: #f0f0f0;
            color: #999;
        }

        /* Animation Classes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feature-card, .offer-card, .action-box {
        <script src="/frontend/includes/fragment-loader.js"></script>
    </body>
    </html>
        .feature-card:nth-child(4) { animation-delay: 0.6s; }

        .offer-card:nth-child(2) { animation-delay: 0.3s; }
        .offer-card:nth-child(3) { animation-delay: 0.6s; }

        .action-box:nth-child(2) { animation-delay: 0.2s; }
        .action-box:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav>
            <h1>SmartFly</h1>
            <div class="links">
                <button class="tab-btn active" id="homeTab" onclick="showPanel('home')">Home</button>
                <button class="tab-btn" id="flightsTab" onclick="showPanel('flights')">Flight Lookup</button>
                <button class="tab-btn" id="checkinTab" onclick="showPanel('checkin')">Check-in</button>
                <button class="tab-btn" id="passengerTab" onclick="showPanel('passenger')">Passenger</button>
                <button class="tab-btn" id="adminTab" onclick="showPanel('admin')">Admin Portal</button>
            </div>
        </nav>

        <!-- Toast Container -->
        <div id="toastContainer"></div>

        <main>

            <!-- Home Panel -->
            <div id="homePanel" class="action-panel active">
                <!-- Hero Section -->
                <section class="hero-section">
                    <div class="hero-content">
                        <h2>Welcome to SmartFly</h2>
                        <p class="lead">Fly Smart. Check-In Smarter. Simplifying Air Travel — your journey starts here.</p>
                        <div class="actions">
                            <button onclick="showPanel('flights')" class="btn">Check Flight Status</button>
                            <button onclick="showPanel('checkin')" class="btn primary">Start Check-in</button>
                        </div>
                    </div>
                </section>

                <!-- Quick Actions -->
                <section class="quick-actions">
                    <div class="action-box" onclick="showPanel('flights')">
                        <div class="action-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                            </svg>
                        </div>
                        <h4>Flight Status</h4>
                        <p>Check real-time flight information</p>
                    </div>
                    <div class="action-box" onclick="showPanel('checkin')">
                        <div class="action-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                            </svg>
                        </div>
                        <h4>Online Check-in</h4>
                        <p>Fast and convenient check-in process</p>
                    </div>
                    <div class="action-box" onclick="showPanel('admin')">
                        <div class="action-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        <h4>Admin Portal</h4>
                        <p>Manage flights and passengers</p>
                    </div>
                </section>

                <!-- Features Section -->
                <section class="features-section">
                    <h3>Why Choose SmartFly?</h3>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                </svg>
                            </div>
                            <h4>Fast Check-in</h4>
                            <p>Complete your check-in in minutes with our intelligent system. Save time and avoid long queues.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                            </div>
                            <h4>Real-time Updates</h4>
                            <p>Get instant notifications about your flight status, gate changes, and boarding times.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                                </svg>
                            </div>
                            <h4>Secure System</h4>
                            <p>Your data is protected with state-of-the-art security measures and encryption.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-14h2v7h-2zm0 8h2v2h-2z"/>
                                </svg>
                            </div>
                            <h4>24/7 Support</h4>
                            <p>Our dedicated support team is available around the clock to assist you.</p>
                        </div>
                    </div>
                </section>

                <!-- Latest Offers -->
                <section class="offers-section">
                    <h3>Special Offers</h3>
                    <div class="offers-grid">
                        <div class="offer-card">
                            <span class="offer-tag">Limited Time</span>
                            <h4>Early Bird Special</h4>
                            <p>Book 60 days in advance and save up to 30% on your flight.</p>
                            <button class="btn primary">Learn More</button>
                        </div>
                        <div class="offer-card">
                            <span class="offer-tag">Family</span>
                            <h4>Family Package</h4>
                            <p>Travel with family? Kids under 12 fly at 50% off!</p>
                            <button class="btn primary">Learn More</button>
                        </div>
                        <div class="offer-card">
                            <span class="offer-tag">Business</span>
                            <h4>Business Class Upgrade</h4>
                            <p>Upgrade to business class and get lounge access free.</p>
                            <button class="btn primary">Learn More</button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Flight Lookup Panel -->
            <div id="flightsPanel" class="action-panel">
                <h2>Flight Information</h2>
                <form id="searchForm" class="form-group">
                    <div class="input-group">
                        <label for="searchFlight">Flight Number</label>
                        <input type="text" id="searchFlight" required placeholder="e.g. SF123">
                    </div>
                    <button type="submit" class="btn primary">Search</button>
                </form>
                <div id="searchResults"></div>
            </div>

            <!-- Check-in Panel -->
            <div id="checkinPanel" class="action-panel">
                <h2>Flight Check-in</h2>
                <form id="checkinForm" class="form-group">
                    <div class="input-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="input-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="input-group">
                        <label for="passport">Passport Number</label>
                        <input type="text" id="passport" required>
                    </div>
                    <div class="input-group">
                        <label for="flight">Flight Number</label>
                        <input type="text" id="flight" required>
                    </div>
                    <button type="submit" class="btn primary">Start Check-in</button>
                </form>
                <div id="checkinResult"></div>
            </div>

                        <!-- Passenger Panel (merged inline) -->
                        <div id="passengerPanel" class="action-panel" style="display:none">
                                <h2>Passenger check-in</h2>
                                <div id="passengerWrapper">
                                        <div id="wizard">
                                            <ol id="steps">
                                                <li class="step active" data-step="start">Start</li>
                                                <li class="step" data-step="auth">Login / Register</li>
                                                <li class="step" data-step="lookup">Flight Lookup</li>
                                                <li class="step" data-step="select">Select Flight</li>
                                                <li class="step" data-step="confirm">Confirm Details</li>
                                                <li class="step" data-step="seat">Seat Selection</li>
                                                <li class="step" data-step="baggage">Baggage & Pay</li>
                                                <li class="step" data-step="boarding">Generate Boarding Pass</li>
                                                <li class="step" data-step="done">Done</li>
                                            </ol>

                                            <section id="stepContent">
                                                <div id="start" class="pane">
                                                    <p>Welcome — proceed to Login or Register to begin.</p>
                                                    <button id="toAuth" class="btn">Login / Register</button>
                                                </div>

                                                <div id="auth" class="pane" style="display:none">
                                                    <h3>Login or Register</h3>
                                                    <form id="authForm" class="form-group">
                                                        <label>Full name <input id="authName" placeholder="Full name"></label>
                                                        <label>Passport/ID <input id="authPassport" placeholder="Passport or ID"></label>
                                                        <label>Email <input id="authEmail" type="email" placeholder="email (optional)"></label>
                                                        <label>Phone <input id="authPhone" placeholder="phone (optional)"></label>
                                                        <button type="submit" class="btn primary">Continue</button>
                                                    </form>
                                                    <div id="authMsg" class="message"></div>
                                                </div>

                                                <div id="lookup" class="pane" style="display:none">
                                                    <h3>Find your booking (optional)</h3>
                                                    <form id="lookupForm" class="form-group">
                                                        <label>Booking ref or ticket#<input id="lookupRef"></label>
                                                        <label>Passport/ID<input id="lookupPassport"></label>
                                                        <label>Name<input id="lookupName"></label>
                                                        <button id="doLookup" class="btn">Search</button>
                                                    </form>
                                                    <div id="lookupResults"></div>
                                                </div>

                                                <div id="select" class="pane" style="display:none">
                                                    <h3>Select flight</h3>
                                                    <div id="flightList">Loading flights...</div>
                                                </div>

                                                <div id="confirm" class="pane" style="display:none">
                                                    <h3>Confirm passenger details</h3>
                                                    <div id="confirmDetails"></div>
                                                    <div style="display:flex;gap:8px;margin-top:8px">
                                                        <button id="editDetails" class="btn">Edit</button>
                                                        <button id="toSeat" class="btn primary">Next: Seat Selection</button>
                                                    </div>
                                                </div>

                                                <div id="seat" class="pane" style="display:none">
                                                    <h3>Seat selection</h3>
                                                    <label>Seat preference <input id="seatPref" placeholder="e.g. 12"></label>
                                                    <div id="seatMsg" class="message"></div>
                                                    <div id="seatMap" style="margin-top:12px"></div>
                                                    <button id="assignSeatBtn" class="btn">Assign seat</button>
                                                </div>

                                                <div id="baggage" class="pane" style="display:none">
                                                    <h3>Baggage & Payment</h3>
                                                    <label>Number of bags <input id="bagCount" type="number" min="0" value="0"></label>
                                                    <p>Fee: <span id="bagFee">$0</span></p>
                                                    <button id="payBags" class="btn primary">Pay baggage fees</button>
                                                </div>

                                                <div id="boarding" class="pane" style="display:none">
                                                    <h3>Boarding pass</h3>
                                                    <p>Generate and download your boarding pass below.</p>
                                                    <button id="generateBP" class="btn primary">Generate Boarding Pass</button>
                                                    <div id="bpResult"></div>
                                                </div>

                                                <div id="done" class="pane" style="display:none">
                                                    <h3>Ready to board</h3>
                                                    <p id="doneMsg">You're all set. Notifications will be sent for updates.</p>
                                                    <p><a href="#" onclick="showPanel('home')">Home</a> | <a id="p_logout" href="#">Logout</a></p>
                                                </div>
                                            </section>
                                        </div>
                                </div>
                        </div>

            <!-- Admin Panel -->
            <div id="adminPanel" class="action-panel">
                <!-- Admin Login Form -->
                <div id="adminLogin" class="admin-login-container">
                    <div class="admin-login-box">
                        <h2>Admin Access Required</h2>
                        <p>Please login to access the admin dashboard</p>
                        <form id="adminForm" class="form-group">
                            <div class="input-group">
                                <label for="adminUsername">Username</label>
                                <input type="text" id="adminUsername" required>
                            </div>
                            <div class="input-group">
                                <label for="adminPassword">Password</label>
                                <input type="password" id="adminPassword" required>
                            </div>
                            <button type="submit" class="btn primary">Login</button>
                        </form>
                    </div>
                </div>

                <!-- Admin Dashboard (hidden until login) -->
                <div id="adminTools" style="display:none">
                    <div class="admin-header">
                        <h2>Admin Dashboard</h2>
                        <div class="admin-actions">
                            <span id="adminUsername-display"></span>
                            <button onclick="adminLogout()" class="btn danger">Logout</button>
                        </div>
                    </div>

                    <div class="admin-nav">
                        <button onclick="showAdminSection('flights')" class="btn">
                            <svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>
                            Flights
                        </button>
                        <button onclick="showAdminSection('passengers')" class="btn">
                            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                            Passengers
                        </button>
                        <button onclick="showAdminSection('bookings')" class="btn">
                            <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                            Bookings
                        </button>
                    </div>

                    <!-- Flights Management -->
                    <div id="adminFlights" class="admin-section">
                        <div class="header-actions">
                            <h3>Manage Flights</h3>
                            <div>
                                <button onclick="showAddFlightForm()" class="btn primary small">
                                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                    Add Flight
                                </button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <input type="text" id="flightSearch" placeholder="Search flights...">
                            <select id="flightStatusFilter">
                                <option value="all">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button onclick="refreshFlights()" class="btn small">Refresh</button>
                        </div>
                        <div id="flightsList" class="data-grid"></div>
                    </div>

                    <!-- Passengers Management -->
                    <div id="adminPassengers" class="admin-section" style="display:none">
                        <div class="header-actions">
                            <h3>Manage Passengers</h3>
                            <button onclick="exportPassengerList()" class="btn secondary small">
                                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                                Export List
                            </button>
                        </div>
                        <div class="filter-group">
                            <input type="text" id="passengerSearch" placeholder="Search passengers...">
                            <input type="text" id="filterFlight" placeholder="Filter by flight">
                            <button onclick="refreshPassengerList()" class="btn small">Refresh</button>
                        </div>
                        <div id="passengersList" class="data-grid"></div>
                    </div>

                    <!-- Bookings Management -->
                    <div id="adminBookings" class="admin-section" style="display:none">
                        <div class="header-actions">
                            <h3>Manage Bookings</h3>
                            <button onclick="showAddBookingForm()" class="btn primary small">
                                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                Add Booking
                            </button>
                        </div>
                        <div class="filter-group">
                            <input type="text" id="bookingSearch" placeholder="Search bookings...">
                            <select id="bookingStatusFilter">
                                <option value="all">All Statuses</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button onclick="refreshBookings()" class="btn small">Refresh</button>
                        </div>
                        <div id="bookingsList" class="data-grid"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Add Flight Modal -->
        <div id="addFlightModal" class="modal">
            <div class="modal-content">
                <h3>Add New Flight</h3>
                <form id="addFlightForm" class="form-group">
                    <div class="input-group">
                        <label for="newFlightNumber">Flight Number</label>
                        <input type="text" id="newFlightNumber" required>
                    </div>
                    <div class="input-group">
                        <label for="newFlightTime">Time</label>
                        <input type="text" id="newFlightTime" class="date-picker" required>
                    </div>
                    <div class="input-group">
                        <label for="newFlightAircraft">Aircraft</label>
                        <input type="text" id="newFlightAircraft" required>
                    </div>
                    <div class="input-group">
                        <label for="newFlightGate">Gate</label>
                        <input type="text" id="newFlightGate" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn primary">Create</button>
                        <button type="button" onclick="hideAddFlightModal()" class="btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Panel Management
        function showPanel(id) {
            // Hide all panels
            document.querySelectorAll('.action-panel').forEach(panel => panel.style.display = 'none');
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
            
            // Show selected panel
            document.getElementById(id + 'Panel').style.display = 'block';
            document.getElementById(id + 'Tab').classList.add('active');
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `${message}<button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;margin-left:10px">×</button>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Flight Search
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const flight = document.getElementById('searchFlight').value;
            try {
                const res = await fetch('/api/flights');
                const data = await res.json();
                const found = data.flights.find(f => f.flight === flight);
                const results = document.getElementById('searchResults');
                if (found) {
                    results.innerHTML = `
                        <div class="card">
                            <h4>${found.flight}</h4>
                            <p>Time: ${found.time || 'N/A'}</p>
                            <p>Gate: ${found.gate || 'TBA'}</p>
                            <p>Status: ${found.checkin_enabled ? 'Check-in Open' : 'Check-in Closed'}</p>
                        </div>
                    `;
                } else {
                    results.innerHTML = '<p class="error">Flight not found</p>';
                }
            } catch (err) {
                showToast('Error searching flights', 'error');
            }
        });

        // Check-in
        document.getElementById('checkinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const passport = document.getElementById('checkinPassport').value;
            const flight = document.getElementById('checkinFlight').value;
            try {
                const res = await fetch('/api/checkin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ flight, passengers: [{ passport }] })
                });
                if (res.ok) {
                    showToast('Check-in successful!');
                    document.getElementById('checkinResult').innerHTML = '<p class="success">Check-in completed. You can now download your boarding pass.</p>';
                } else {
                    const error = await res.json();
                    showToast(error.error || 'Check-in failed', 'error');
                }
            } catch (err) {
                showToast('Error during check-in', 'error');
            }
        });

        // Admin Login
        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ role: 'admin', username, password })
                });
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('session', data.token);
                    showToast('Login successful!');
                    document.getElementById('adminForm').style.display = 'none';
                    document.getElementById('adminTools').style.display = 'block';
                    loadFlights();
                } else {
                    showToast('Invalid credentials', 'error');
                }
            } catch (err) {
                showToast('Login failed', 'error');
            }
        });

        // Admin Functions
        function showAdminSection(section) {
            document.getElementById('adminFlights').style.display = section === 'flights' ? 'block' : 'none';
            document.getElementById('adminPassengers').style.display = section === 'passengers' ? 'block' : 'none';
        }

        async function loadFlights() {
            try {
                const res = await fetch('/api/flights', {
                    headers: {'X-SESSION': localStorage.getItem('session')}
                });
                const data = await res.json();
                const list = document.getElementById('flightsList');
                list.innerHTML = data.flights.map(f => `
                    <div class="card" style="margin:5px 0;padding:10px">
                        <strong>${f.flight}</strong>
                        <p>Time: ${f.time || 'N/A'}</p>
                        <p>Gate: ${f.gate || 'TBA'}</p>
                        <button onclick="toggleCheckin('${f.flight}')" class="btn small">
                            ${f.checkin_enabled ? 'Disable' : 'Enable'} Check-in
                        </button>
                    </div>
                `).join('');
            } catch (err) {
                showToast('Error loading flights', 'error');
            }
        }

        function showAddFlightForm() {
            document.getElementById('addFlightModal').style.display = 'flex';
        }

        function hideAddFlightModal() {
            document.getElementById('addFlightModal').style.display = 'none';
        }

        document.getElementById('addFlightForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const flight = document.getElementById('newFlightNumber').value;
            const time = document.getElementById('newFlightTime').value;
            const aircraft = document.getElementById('newFlightAircraft').value;
            const gate = document.getElementById('newFlightGate').value;
            
            try {
                const res = await fetch('/api/flights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-SESSION': localStorage.getItem('session')
                    },
                    body: JSON.stringify({ flight, time, aircraft, gate })
                });
                if (res.ok) {
                    showToast('Flight created successfully');
                    hideAddFlightModal();
                    loadFlights();
                } else {
                    showToast('Failed to create flight', 'error');
                }
            } catch (err) {
                showToast('Error creating flight', 'error');
            }
        });

        async function toggleCheckin(flight) {
            try {
                const res = await fetch(`/api/flights/${flight}/checkin-toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-SESSION': localStorage.getItem('session')
                    },
                    body: JSON.stringify({ enabled: true })
                });
                if (res.ok) {
                    showToast('Check-in status updated');
                    loadFlights();
                } else {
                    showToast('Failed to update check-in status', 'error');
                }
            } catch (err) {
                showToast('Error updating check-in status', 'error');
            }
        }

        function adminLogout() {
            localStorage.removeItem('session');
            document.getElementById('adminForm').style.display = 'block';
            document.getElementById('adminTools').style.display = 'none';
            showToast('Logged out successfully');
        }

        // Check for existing admin session
        if (localStorage.getItem('session')) {
            document.getElementById('adminForm').style.display = 'none';
            document.getElementById('adminTools').style.display = 'block';
            loadFlights();
        }

        // Initialize date pickers
        flatpickr(".date-picker", {
            minDate: "today",
            dateFormat: "Y-m-d",
        });

        // Passenger selection dropdown
        const passengerSelect = document.getElementById('passengerSelect');
        const passengerCount = document.getElementById('passengerCount');
        
        document.querySelector('.passenger-trigger').addEventListener('click', () => {
            passengerSelect.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!passengerSelect.contains(e.target)) {
                passengerSelect.classList.remove('active');
            }
        });

        // Handle passenger count changes
        document.querySelectorAll('.number-input button').forEach(button => {
            button.addEventListener('click', (e) => {
                const input = e.target.parentNode.querySelector('input');
                const action = e.target.dataset.action;
                const currentValue = parseInt(input.value);
                
                if (action === 'increase' && currentValue < parseInt(input.max)) {
                    input.value = currentValue + 1;
                } else if (action === 'decrease' && currentValue > parseInt(input.min)) {
                    input.value = currentValue - 1;
                }
                
                updatePassengerCount();
            });
        });

        function updatePassengerCount() {
            const inputs = document.querySelectorAll('.passenger-type input');
            const total = Array.from(inputs).reduce((sum, input) => sum + parseInt(input.value), 0);
            passengerCount.textContent = `${total} Passenger${total !== 1 ? 's' : ''}`;
        }

        // Swap airports
        document.getElementById('swapBtn').addEventListener('click', () => {
            const from = document.getElementById('from');
            const to = document.getElementById('to');
            [from.value, to.value] = [to.value, from.value];
        });

        // Handle flight search form submission
        document.getElementById('flightSearchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // Add your flight search logic here
            window.location.href = '/flight-results.html';
        });
    </script>

    <script>
        // Panel Management
        function showPanel(id) {
            // Hide all panels
            document.querySelectorAll('.action-panel').forEach(panel => {
                panel.style.display = 'none';
                panel.classList.remove('active');
            });
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
            
            // Show selected panel
            const panel = document.getElementById(id + 'Panel');
            panel.style.display = 'block';
            panel.classList.add('active');
            document.getElementById(id + 'Tab').classList.add('active');
        }        // Toast Notifications
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `${message}<button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;margin-left:10px">×</button>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Flight Search
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const flight = document.getElementById('searchFlight').value;
            try {
                const res = await fetch('/api/flights');
                const data = await res.json();
                const found = data.flights.find(f => f.flight === flight);
                const results = document.getElementById('searchResults');
                if (found) {
                    results.innerHTML = `
                        <div class="card">
                            <h4>${found.flight}</h4>
                            <p>Time: ${found.time || 'N/A'}</p>
                            <p>Gate: ${found.gate || 'TBA'}</p>
                            <p>Status: ${found.checkin_enabled ? 'Check-in Open' : 'Check-in Closed'}</p>
                        </div>
                    `;
                } else {
                    results.innerHTML = '<p class="error">Flight not found</p>';
                }
            } catch (err) {
                showToast('Error searching flights', 'error');
            }
        });

        // Check-in Form Submit
        document.getElementById('checkinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const passport = document.getElementById('passport').value.trim();
            const flight = document.getElementById('flight').value.trim();

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, email, passport, flight })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Check-in successful!');
                    // Redirect to boarding pass
                    window.location.href = `/api/boardingpass?passport=${encodeURIComponent(passport)}`;
                } else {
                    showToast(data.error || 'Check-in failed', 'error');
                }
            } catch (err) {
                showToast('Error during check-in', 'error');
            }
        });

        // Admin Login
        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ role: 'admin', username, password })
                });
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('session', data.token);
                    document.cookie = 'session=' + encodeURIComponent(data.token) + ';path=/';
                    showToast('Login successful!');
                    document.getElementById('adminForm').style.display = 'none';
                    document.getElementById('adminTools').style.display = 'block';
                    loadFlights();
                } else {
                    showToast('Invalid credentials', 'error');
                }
            } catch (err) {
                showToast('Login failed', 'error');
            }
        });

        // Admin Functions
        function showAdminSection(section) {
            document.getElementById('adminFlights').style.display = section === 'flights' ? 'block' : 'none';
            document.getElementById('adminPassengers').style.display = section === 'passengers' ? 'block' : 'none';
            if (section === 'passengers') {
                refreshPassengerList();
            }
        }

        async function loadFlights() {
            try {
                const res = await fetch('/api/flights', {
                    headers: {'X-SESSION': localStorage.getItem('session')}
                });
                const data = await res.json();
                const list = document.getElementById('flightsList');
                list.innerHTML = data.flights.map(f => `
                    <div class="card">
                        <strong>${f.flight}</strong>
                        <p>Time: ${f.time || 'N/A'}</p>
                        <p>Gate: ${f.gate || 'TBA'}</p>
                        <button onclick="toggleCheckin('${f.flight}')" class="btn small">
                            ${f.checkin_enabled ? 'Disable' : 'Enable'} Check-in
                        </button>
                    </div>
                `).join('');
            } catch (err) {
                showToast('Error loading flights', 'error');
            }
        }

        function showAddFlightForm() {
            document.getElementById('addFlightModal').style.display = 'flex';
        }

        function hideAddFlightModal() {
            document.getElementById('addFlightModal').style.display = 'none';
        }

        // Add Flight Form
        document.getElementById('addFlightForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const flight = document.getElementById('newFlightNumber').value;
            const time = document.getElementById('newFlightTime').value;
            const aircraft = document.getElementById('newFlightAircraft').value;
            const gate = document.getElementById('newFlightGate').value;
            
            try {
                const res = await fetch('/api/flights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-SESSION': localStorage.getItem('session')
                    },
                    body: JSON.stringify({ flight, time, aircraft, gate })
                });
                if (res.ok) {
                    showToast('Flight created successfully');
                    hideAddFlightModal();
                    loadFlights();
                } else {
                    showToast('Failed to create flight', 'error');
                }
            } catch (err) {
                showToast('Error creating flight', 'error');
            }
        });

        // Toggle Check-in Status
        async function toggleCheckin(flight) {
            try {
                const res = await fetch(`/api/flights/${flight}/checkin-toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-SESSION': localStorage.getItem('session')
                    }
                });
                if (res.ok) {
                    showToast('Check-in status updated');
                    loadFlights();
                } else {
                    showToast('Failed to update check-in status', 'error');
                }
            } catch (err) {
                showToast('Error updating check-in status', 'error');
            }
        }

        // Passenger Management
        async function fetchPassengers() {
            try {
                const res = await fetch('/api/passengers', {
                    headers: {'X-SESSION': localStorage.getItem('session')}
                });
                return res.ok ? await res.json() : [];
            } catch (err) {
                showToast('Error fetching passengers', 'error');
                return [];
            }
        }

        function renderPassengerTable(data) {
            const container = document.getElementById("passengersList");
            container.innerHTML = "";
            if (!data.length) {
                container.innerHTML = '<div class="empty">No passengers found.</div>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'pass-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Passport</th>
                        <th>Flight</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${escapeHtml(p.name)}</td>
                            <td>${escapeHtml(p.email || '')}</td>
                            <td>${escapeHtml(p.passport)}</td>
                            <td>${escapeHtml(p.flight)}</td>
                            <td>${p.checked_in ? 'Checked In' : 'Registered'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            container.appendChild(table);
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[c]);
        }

        async function refreshPassengerList() {
            const passengers = await fetchPassengers();
            const filter = document.getElementById("filterFlight").value.trim().toLowerCase();
            const filtered = filter ? 
                passengers.filter(p => p.flight && p.flight.toLowerCase().includes(filter)) : 
                passengers;
            renderPassengerTable(filtered);
        }

        function adminLogout() {
            localStorage.removeItem('session');
            document.cookie = 'session=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            document.getElementById('adminForm').style.display = 'block';
            document.getElementById('adminTools').style.display = 'none';
            showToast('Logged out successfully');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize date pickers
            flatpickr(".date-picker", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                minDate: "today"
            });

            // Set up passenger list filter
            document.getElementById("filterFlight")?.addEventListener("input", refreshPassengerList);
            document.getElementById("refreshBtn")?.addEventListener("click", refreshPassengerList);

            // Check for existing admin session
            if (localStorage.getItem('session')) {
                document.getElementById('adminForm').style.display = 'none';
                document.getElementById('adminTools').style.display = 'block';
                loadFlights();
            }

            // Show initial panel
            showPanel('home');
        });
    </script>

        <!-- Passenger dashboard script (merged) -->
        <script>
            // Isolated passenger state to avoid colliding with admin UI
            const passengerW = {
                token: localStorage.getItem('session'),
                state: { passenger: {}, selectedFlight: null }
            };

            function setPassengerStep(name) {
                // steps and panes scoped inside passengerPanel
                document.querySelectorAll('#passengerPanel #steps .step').forEach(s=>{
                    s.classList.remove('active');
                    // Make steps clickable once unlocked
                    const stepName = s.getAttribute('data-step');
                    if (isStepUnlocked(stepName)) {
                        s.style.cursor = 'pointer';
                        s.style.opacity = '1';
                    } else {
                        s.style.cursor = 'not-allowed';
                        s.style.opacity = '0.5';
                    }
                });
                const el = document.querySelector(`#passengerPanel #steps .step[data-step="${name}"]`);
                if (el) el.classList.add('active');
                document.querySelectorAll('#passengerPanel #stepContent .pane').forEach(p=>p.style.display='none');
                const pane = document.querySelector(`#passengerPanel #${name}`);
                if (pane) pane.style.display = 'block';
            }

            function isStepUnlocked(stepName) {
                // Define step order and unlocking conditions
                const steps = ['start', 'auth', 'lookup', 'select', 'confirm', 'seat', 'baggage', 'boarding', 'done'];
                const currentStepIndex = steps.indexOf(stepName);
                
                // Start is always accessible
                if (stepName === 'start') return true;
                
                // Check prerequisites
                if (stepName === 'auth' || stepName === 'lookup') {
                    return true; // These are always accessible after start
                }
                
                if (stepName === 'select') {
                    return !!passengerW.token; // Need to be logged in
                }
                
                if (stepName === 'confirm') {
                    return !!passengerW.state.selectedFlight;
                }
                
                if (stepName === 'seat') {
                    return !!passengerW.state.passenger.name && !!passengerW.state.selectedFlight;
                }
                
                if (stepName === 'baggage') {
                    return !!document.getElementById('seatMsg')?.textContent?.includes('assigned');
                }
                
                if (stepName === 'boarding') {
                    return document.getElementById('bagFee')?.textContent === '$0' || 
                           document.getElementById('bpResult')?.innerHTML?.includes('Boarding Pass');
                }
                
                if (stepName === 'done') {
                    return !!document.getElementById('bpResult')?.innerHTML?.includes('Boarding Pass');
                }
                
                return false;
            }

            // Wire the passenger UI
            document.addEventListener('click', (e) => {
                // toAuth button
                if (e.target && e.target.id === 'toAuth') { e.preventDefault(); setPassengerStep('auth'); }
            });

            // Auth form
            document.getElementById('authForm').addEventListener('submit', async (e)=>{
                e.preventDefault();
                const email = document.getElementById('authEmail').value.trim();
                const phone = document.getElementById('authPhone').value.trim();
                const name = document.getElementById('authName').value.trim();
                const passport = document.getElementById('authPassport').value.trim();
                const payload = { role: 'passenger', email: email || undefined, phone: phone || undefined, name: name || undefined, passport: passport || undefined };
                const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const j = await res.json().catch(()=>({}));
                const msg = document.getElementById('authMsg');
                if (!res.ok) { msg.innerText = 'Login failed: ' + (j.error || j.detail || 'unknown'); msg.className='message error'; return; }
                passengerW.token = j.token; localStorage.setItem('session', j.token); document.cookie = `session=${j.token};path=/`;
                passengerW.state.passenger = { name: name || '', passport: passport || '', email: email || '', phone: phone || '' };
                setPassengerStep('lookup');
            });

            // Lookup
            document.getElementById('doLookup').addEventListener('click', async (e)=>{
                e.preventDefault();
                const ref = document.getElementById('lookupRef').value.trim();
                const passport = document.getElementById('lookupPassport').value.trim();
                const name = document.getElementById('lookupName').value.trim();
                const body = {};
                if (ref) body.booking_ref = ref;
                if (passport) body.passport = passport;
                if (name) body.name = name;
                const res = await fetch('/api/lookup', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const j = await res.json().catch(()=>({}));
                const el = document.getElementById('lookupResults');
                if (!res.ok) { el.innerText = 'Lookup failed'; return; }
                if (!j.results || j.results.length === 0) { el.innerHTML = '<p>No bookings found. Continue to select a flight.</p><button id="skipToSelect" class="btn">Continue</button>'; document.getElementById('skipToSelect').addEventListener('click', ()=>setPassengerStep('select')); return; }
                el.innerHTML = j.results.map(p=>`<div class="card"><b>${p.name}</b> — ${p.flight || 'No flight'}<br/>Passport: ${p.passport}<br/><button class="useResult btn" data-passport="${p.passport}">Use this</button></div>`).join('');
                el.querySelectorAll('.useResult').forEach(b=>b.addEventListener('click', (ev)=>{ const pp = ev.target.getAttribute('data-passport'); passengerW.state.passenger = j.results.find(x=>x.passport===pp) || passengerW.state.passenger; setPassengerStep('select'); loadFlightsForPassenger(); }));
            });

            // Flights list for passenger selection
            async function loadFlightsForPassenger(){
                const el = document.getElementById('flightList');
                el.innerHTML = 'Loading...';
                try{
                    const r = await fetch('/api/flights'); const j = await r.json();
                    if (!r.ok) { el.innerHTML = 'Failed to load flights'; return; }
                    if (!j.flights || j.flights.length===0) { el.innerHTML = '<p>No flights</p>'; return; }
                    el.innerHTML = j.flights.map(f=>`<div class="card"><b>${f.flight}</b> — ${f.time||'N/A'} <br/>Capacity: ${f.capacity||'∞'} <br/><button class="selectFlight btn" data-flight="${f.flight}">Select</button></div>`).join('');
                    el.querySelectorAll('.selectFlight').forEach(b=>b.addEventListener('click', (ev)=>{ passengerW.state.selectedFlight = ev.target.getAttribute('data-flight'); setPassengerStep('confirm'); renderPassengerConfirm(); }));
                }catch(err){ el.innerHTML = 'Failed to load flights'; }
            }

            // Load and render seat map for a flight inside passenger pane
            async function loadSeatMapForPassenger(flight){
                const mapEl = document.getElementById('seatMap');
                const msg = document.getElementById('seatMsg');
                if (!mapEl) return;
                mapEl.innerHTML = 'Loading seat map...';
                if (!flight) { mapEl.innerHTML = '<p class="empty">No flight selected</p>'; return; }
                try{
                    const res = await fetch(`/api/flights/${encodeURIComponent(flight)}/seats`);
                    if (!res.ok) { mapEl.innerHTML = '<p class="empty">Failed to load seat map</p>'; return; }
                    const j = await res.json();
                    const seats = j.seats || [];
                    if (seats.length === 0) { mapEl.innerHTML = '<p class="empty">No seat data</p>'; return; }
                    const frag = document.createElement('div');
                    frag.style.display = 'flex';
                    frag.style.flexWrap = 'wrap';
                    frag.style.gap = '8px';
                    seats.forEach(s => {
                        const b = document.createElement('button');
                        b.className = 'btn';
                        b.textContent = s.seat;
                        b.style.minWidth = '56px';
                        b.style.padding = '8px';
                        b.dataset.seat = s.seat;
                        if (s.status === 'taken') { b.disabled = true; b.style.background = '#eee'; b.title = (s.passenger && s.passenger.name) ? `Taken by ${s.passenger.name}` : 'Taken'; }
                        else if (s.status === 'blocked') { b.disabled = true; b.style.background = '#f8d7da'; b.title = 'Blocked/Unavailable'; }
                        else if (s.status === 'available') { b.style.background = '#e8f5e9'; b.title = 'Available'; }
                        frag.appendChild(b);
                        b.addEventListener('click', async (ev) => {
                            const seat = ev.currentTarget.dataset.seat;
                            msg.innerText = 'Selecting seat ' + seat + '...'; msg.className='message';
                            try{
                                const token = passengerW.token;
                                const selectRes = await fetch(`/api/flights/${encodeURIComponent(flight)}/seats/select`, { method: 'POST', headers: {'Content-Type':'application/json','X-SESSION': token}, body: JSON.stringify({ seat }) });
                                if (selectRes.ok){ const rj = await selectRes.json(); passengerW.state.passenger.seat = rj.seat; msg.innerText = 'Seat assigned: ' + rj.seat; msg.className='message success'; loadSeatMapForPassenger(flight); return; }
                                if (selectRes.status === 401 || selectRes.status === 403){
                                    msg.innerText = 'Seat select unauthorized via seat API — trying fallback check-in...'; msg.className='message error';
                                    const checkinBody = { flight: flight, passengers: [ { name: passengerW.state.passenger.name || '', passport: passengerW.state.passenger.passport || '', seat: seat } ] };
                                    const cRes = await fetch('/api/checkin', { method: 'POST', headers: {'Content-Type':'application/json','X-SESSION': passengerW.token}, body: JSON.stringify(checkinBody) });
                                    const cj = await cRes.json().catch(()=>({}));
                                    if (cRes.ok){ const r = (cj.results && cj.results[0]) || {}; passengerW.state.passenger.seat = r.seat || seat; msg.innerText = 'Seat assigned (checkin): ' + (r.seat || seat); msg.className='message success'; loadSeatMapForPassenger(flight); return; }
                                    msg.innerText = 'Seat assign failed: ' + (cj.error || cj.detail || (cj.results && cj.results[0] && cj.results[0].detail) || 'unauthorized'); msg.className='message error';
                                } else {
                                    const errj = await selectRes.json().catch(()=>({}));
                                    msg.innerText = 'Seat assign failed: ' + (errj.error || errj.detail || 'unknown'); msg.className='message error';
                                }
                            }catch(err){ msg.innerText = 'Seat assign error: ' + String(err); msg.className='message error'; }
                        });
                    });
                    mapEl.innerHTML = '';
                    mapEl.appendChild(frag);
                }catch(err){ mapEl.innerHTML = '<p class="empty">Error fetching seat map</p>'; }
            }

            function renderPassengerConfirm(){
                const d = document.getElementById('confirmDetails');
                const p = passengerW.state.passenger || {};
                d.innerHTML = `
                    <p>Name: <input id="cname" value="${p.name || ''}"></p>
                    <p>Passport: <input id="cpassport" value="${p.passport || ''}"></p>
                    <p>Email: <input id="cemail" value="${p.email || ''}"></p>
                    <p>Phone: <input id="cphone" value="${p.phone || ''}"></p>
                    <p>Selected flight: <b>${passengerW.state.selectedFlight}</b></p>
                `;
                document.getElementById('editDetails').addEventListener('click', ()=>{ document.getElementById('cname').removeAttribute('readonly'); });
                document.getElementById('toSeat').addEventListener('click', ()=>{
                    passengerW.state.passenger.name = document.getElementById('cname').value.trim();
                    passengerW.state.passenger.passport = document.getElementById('cpassport').value.trim();
                    passengerW.state.passenger.email = document.getElementById('cemail').value.trim();
                    passengerW.state.passenger.phone = document.getElementById('cphone').value.trim();
                    setPassengerStep('seat');
                    // Load seat map for selected flight
                    try{ loadSeatMapForPassenger(passengerW.state.selectedFlight); }catch(e){}
                });
            }

            // Seat selection: use passenger-safe /api/checkin so passengers (with session) can set seat preference
            document.getElementById('assignSeatBtn').addEventListener('click', async ()=>{
                const seat = document.getElementById('seatPref').value.trim();
                const passport = passengerW.state.passenger.passport;
                const name = passengerW.state.passenger.name || '';
                const flight = passengerW.state.selectedFlight;
                const msg = document.getElementById('seatMsg');
                if (!flight) { msg.innerText = 'No flight selected'; msg.className='message error'; return; }
                if (!passport) { msg.innerText = 'No passport available'; msg.className='message error'; return; }

                try {
                    const body = { flight: flight, passengers: [ { name: name, passport: passport, seat: seat } ] };
                    const res = await fetch('/api/checkin', { method: 'POST', headers: {'Content-Type':'application/json','X-SESSION': passengerW.token}, body: JSON.stringify(body) });
                    const j = await res.json().catch(()=>({}));
                    if (!res.ok) {
                        msg.innerText = 'Seat assign failed: ' + (j.error || j.detail || (j.results && j.results[0] && j.results[0].detail) || 'unknown');
                        msg.className = 'message error';
                        return;
                    }
                    // /api/checkin returns { results: [ { passport, status, seat, ... } ] }
                    const result = (j.results && j.results[0]) || {};
                    if (result.status === 'ok') {
                        passengerW.state.passenger.seat = result.seat || seat;
                        msg.innerText = 'Seat assigned: ' + (result.seat || seat);
                        msg.className = 'message success';
                        setPassengerStep('baggage');
                    } else {
                        msg.innerText = 'Seat assign failed: ' + (result.detail || result.status || 'unknown');
                        msg.className = 'message error';
                    }
                } catch (err) {
                    msg.innerText = 'Seat assign error: ' + String(err);
                    msg.className = 'message error';
                }
            });

            // baggage
            function recalcBagFee() { const n = parseInt(document.getElementById('bagCount').value||0); const fee = n<=1?0:50*(n-1); document.getElementById('bagFee').innerText = '$'+fee; return fee; }
            document.getElementById('bagCount').addEventListener('input', recalcBagFee);
            document.getElementById('payBags').addEventListener('click', async ()=>{
                const fee = recalcBagFee(); if (fee<=0){ alert('No fee'); setPassengerStep('boarding'); return; }
                const passport = passengerW.state.passenger.passport;
                const res = await fetch('/api/baggage/pay', { method: 'POST', headers: {'Content-Type':'application/json','X-SESSION': passengerW.token}, body: JSON.stringify({ passport, amount: fee }) });
                const j = await res.json().catch(()=>({}));
                if (!res.ok) { alert('Payment failed: ' + (j.error||j.detail||'unknown')); return; }
                alert('Payment recorded'); setPassengerStep('boarding');
            });

            // boarding pass
            document.getElementById('generateBP').addEventListener('click', async ()=>{
                const passport = passengerW.state.passenger.passport;
                const res = await fetch(`/api/boardingpass?passport=${encodeURIComponent(passport)}`, { headers: { 'X-SESSION': passengerW.token }});
                const el = document.getElementById('bpResult');
                if (!res.ok) { const j = await res.json().catch(()=>({})); el.innerText = 'Failed to generate: ' + (j.error || j.detail || 'unknown'); return; }
                const blob = await res.blob(); const url = URL.createObjectURL(blob);
                el.innerHTML = `<a href="${url}" target="_blank" class="btn primary">Open Boarding Pass</a>`;
                setPassengerStep('done');
            });

            // passenger logout
            document.getElementById('p_logout').addEventListener('click', async (e)=>{
                e.preventDefault(); const token = localStorage.getItem('session'); await fetch('/api/logout', { method: 'POST', headers: { 'X-SESSION': token }}); localStorage.removeItem('session'); document.cookie='session=;path=/;max-age=0'; setPassengerStep('start'); showPanel('home');
            });

            // Step navigation
            document.querySelector('#passengerPanel #steps').addEventListener('click', (e) => {
                const step = e.target.closest('.step');
                if (!step) return;
                
                const stepName = step.getAttribute('data-step');
                if (!stepName || !isStepUnlocked(stepName)) return;
                
                setPassengerStep(stepName);
                
                // Load data if needed
                if (stepName === 'select') {
                    loadFlightsForPassenger();
                }
                if (stepName === 'confirm') {
                    renderPassengerConfirm();
                }
            });

            // Initialize passenger pane on first open
            document.getElementById('passengerTab').addEventListener('click', ()=>{
                // set initial step and populate flights
                setPassengerStep('start'); loadFlightsForPassenger();
            });
        </script>
</body>
</html>
</script>
</body>
</html>