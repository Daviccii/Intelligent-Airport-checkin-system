<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Management - SmartFly Admin</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Include admin layout styles from previous pages */
        .admin-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        /* ... (previous admin styles) ... */

        /* Booking management specific styles */
        .booking-details {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-group label {
            font-size: 13px;
            color: var(--muted);
        }

        .info-group span {
            font-size: 15px;
            font-weight: 500;
        }

        .passenger-list {
            margin-top: 20px;
        }

        .passenger-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .passenger-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .passenger-avatar {
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--accent);
        }

        .passenger-details h4 {
            margin: 0;
            font-size: 15px;
        }

        .passenger-details p {
            margin: 3px 0 0;
            font-size: 13px;
            color: var(--muted);
        }

        .timeline {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            padding-bottom: 20px;
            position: relative;
        }

        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 30px;
            bottom: 0;
            width: 2px;
            background: #e6e9ef;
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .timeline-icon svg {
            width: 16px;
            height: 16px;
            fill: var(--accent);
        }

        .timeline-content h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .timeline-content p {
            margin: 5px 0 0;
            font-size: 13px;
            color: var(--muted);
        }

        .payment-info {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e6e9ef;
        }

        .payment-row:last-child {
            border-bottom: none;
            font-weight: 600;
        }

        .payment-row span:first-child {
            color: var(--muted);
        }

        .actions-panel {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #e6e9ef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .status-select {
            padding: 8px 12px;
            border: 1px solid #e6e9ef;
            border-radius: 6px;
            font-size: 14px;
        }
        /* Modal & message styles */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60}
        .modal-box{background:#fff;border-radius:10px;padding:18px;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.2)}
        .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
        #adminMessage{display:none;padding:10px;border-radius:8px;margin-bottom:12px}
        #adminMessage.success{background:#ecfdf5;color:#065f46;border:1px solid #d1fae5}
        #adminMessage.error{background:#fff1f2;color:#9f1239;border:1px solid #fecaca}
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar from dashboard.html -->
        <aside class="admin-sidebar">
            <!-- ... Sidebar content ... -->
        </aside>

        <main class="admin-content">
            <div class="booking-header">
                <div>
                    <h1>Booking #BK-2411</h1>
                    <p style="margin:5px 0 0;color:var(--muted)">Created on Nov 3, 2025</p>
                </div>
                <select class="status-select">
                    <option>Confirmed</option>
                    <option>Pending</option>
                    <option>Cancelled</option>
                </select>
            </div>

            <div class="booking-details">
                <h3>Flight Information</h3>
                <div class="booking-info">
                    <div class="info-group">
                        <label>Flight Number</label>
                        <span>NY-LON-789</span>
                    </div>
                    <div class="info-group">
                        <label>Departure</label>
                        <span>New York (JFK)</span>
                    </div>
                    <div class="info-group">
                        <label>Arrival</label>
                        <span>London (LHR)</span>
                    </div>
                    <div class="info-group">
                        <label>Date</label>
                        <span>Nov 3, 2025</span>
                    </div>
                    <div class="info-group">
                        <label>Time</label>
                        <span>07:30 AM - 09:45 PM</span>
                    </div>
                    <div class="info-group">
                        <label>Class</label>
                        <span>Business</span>
                    </div>
                </div>

                <div class="passenger-list">
                    <h3>Passengers</h3>
                    <div style="margin-bottom:12px">
                        <form id="addPassengerForm" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                            <input id="ap_name" placeholder="Full name" style="padding:8px;border-radius:6px;border:1px solid #e6e9ef" />
                            <input id="ap_passport" placeholder="Passport" style="padding:8px;border-radius:6px;border:1px solid #e6e9ef" />
                            <input id="ap_flight" placeholder="Flight" style="padding:8px;border-radius:6px;border:1px solid #e6e9ef" />
                            <input id="ap_seat" placeholder="Seat (optional)" style="padding:8px;border-radius:6px;border:1px solid #e6e9ef" />
                            <input id="ap_email" placeholder="Email (optional)" style="padding:8px;border-radius:6px;border:1px solid #e6e9ef" />
                            <button class="btn primary" type="submit">Add Passenger</button>
                        </form>
                        <div id="addPassengerMsg" style="margin-top:8px;color:var(--muted)"></div>
                    </div>
                    <div id="adminMessage" role="status" aria-live="polite"></div>
                    <div id="passengerContainer">Loading passengers...</div>
                </div>

                <!-- Delete confirmation modal -->
                <div id="deleteConfirmModal" class="modal-backdrop" aria-hidden="true">
                    <div class="modal-box">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <h3 style="margin:0">Confirm delete</h3>
                            <button id="cancelDeleteBtn" class="btn">Cancel</button>
                        </div>
                        <div id="deleteConfirmText">Are you sure you want to delete this passenger?</div>
                        <div class="modal-actions">
                            <button id="confirmDeleteBtn" class="btn danger">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Edit passenger modal -->
                <div id="editPassengerModal" class="modal-backdrop" aria-hidden="true">
                    <div class="modal-box">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <h3 style="margin:0">Edit passenger</h3>
                            <button id="cancelEditBtn" class="btn">Close</button>
                        </div>
                        <form id="editPassengerForm">
                            <input type="hidden" id="edit_passport" />
                            <input type="hidden" id="edit_flight" />
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <label>Name<br/><input id="edit_name" placeholder="Full name" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef"/></label>
                                <label>Seat<br/><input id="edit_seat" placeholder="Seat" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef"/></label>
                                <label>Email<br/><input id="edit_email" placeholder="Email" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef"/></label>
                            </div>
                            <div class="modal-actions">
                                <button type="button" id="saveEditBtn" class="btn primary">Save</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="timeline">
                    <h3>Booking Timeline</h3>
                    <div class="timeline-item">
                        <div class="timeline-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/>
                            </svg>
                        </div>
                        <div class="timeline-content">
                            <h4>Booking Confirmed</h4>
                            <p>Nov 3, 2025 • 10:30 AM</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.91c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
                            </svg>
                        </div>
                        <div class="timeline-content">
                            <h4>Payment Received</h4>
                            <p>Nov 3, 2025 • 10:32 AM</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </div>
                        <div class="timeline-content">
                            <h4>Confirmation Email Sent</h4>
                            <p>Nov 3, 2025 • 10:33 AM</p>
                        </div>
                    </div>
                </div>

                <div class="payment-info">
                    <h3>Payment Details</h3>
                    <div class="payment-row">
                        <span>Base Fare</span>
                        <span>$650.00</span>
                    </div>
                    <div class="payment-row">
                        <span>Taxes & Fees</span>
                        <span>$80.00</span>
                    </div>
                    <div class="payment-row">
                        <span>Insurance</span>
                        <span>$20.00</span>
                    </div>
                    <div class="payment-row">
                        <span>Total Amount</span>
                        <span>$750.00</span>
                    </div>
                </div>
            </div>

            <div class="actions-panel">
                <button class="btn">Send Email</button>
                <button class="btn">Print Ticket</button>
                <button class="btn">Cancel Booking</button>
                <button class="btn primary">Issue Boarding Pass</button>
            </div>
        </main>
    </div>

    <script>
        // Add your booking management interaction logic here
        document.querySelector('.status-select').addEventListener('change', (e) => {
            // Update booking status
            console.log('Status changed to:', e.target.value);
        });

        const token = (document.cookie.split(';').find(c=>c.trim().startsWith('session='))||'').split('=')[1] || localStorage.getItem('session');

        async function loadPassengers(){
            try{
                const res = await fetch('/api/bookings', { headers: { 'X-SESSION': token } });
                if(!res.ok){ document.getElementById('passengerContainer').textContent = 'Failed to load (unauthorized?)'; return; }
                const j = await res.json();
                const list = j.bookings || [];
                if(!list.length){ document.getElementById('passengerContainer').innerHTML = '<p>No passengers found</p>'; return; }
                const html = list.map(p=>{
                    const initials = (p.name||'').split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase() || 'P';
                    const flight = p.flight || '';
                    const passport = p.passport || '';
                    const seat = p.seat || '';
                    return `
                    <div class="passenger-card" data-passport="${passport}" data-flight="${flight}">
                        <div class="passenger-info">
                            <div class="passenger-avatar">${initials}</div>
                            <div class="passenger-details">
                                <h4>${p.name||'Unnamed'}</h4>
                                <p>Passport: ${passport} • Flight: ${flight} • Seat: ${seat}</p>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn editPassenger" data-passport="${passport}" data-flight="${flight}">Edit</button>
                            <button class="btn danger deletePassenger" data-passport="${passport}" data-flight="${flight}">Delete</button>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('passengerContainer').innerHTML = html;
                // attach handlers via delegation
                document.getElementById('passengerContainer').querySelectorAll('.deletePassenger').forEach(btn=>{
                    btn.addEventListener('click', (e)=>{
                        const pass = btn.dataset.passport; const flight = btn.dataset.flight;
                        openDeleteModal(pass, flight);
                    });
                });
                document.getElementById('passengerContainer').querySelectorAll('.editPassenger').forEach(btn=>{
                    btn.addEventListener('click', (e)=>{
                        const pass = btn.dataset.passport; const flight = btn.dataset.flight;
                        openEditModal(pass, flight);
                    });
                });
            }catch(e){ document.getElementById('passengerContainer').textContent = 'Failed to load passengers'; }
        }

        // Initial load
        loadPassengers();

        // Add passenger form handling
        const addForm = document.getElementById('addPassengerForm');
        if(addForm){
            addForm.addEventListener('submit', async (e)=>{
                e.preventDefault();
                const name = document.getElementById('ap_name').value.trim();
                const passport = document.getElementById('ap_passport').value.trim();
                const flight = document.getElementById('ap_flight').value.trim();
                const seat = document.getElementById('ap_seat').value.trim();
                const email = document.getElementById('ap_email').value.trim();
                const msg = document.getElementById('addPassengerMsg');
                msg.textContent = '';
                if(!name || !passport || !flight){ msg.textContent = 'Name, passport and flight are required'; return; }
                const payload = { name: name, passport: passport, flight: flight };
                if(seat) payload.seat = seat;
                if(email) payload.email = email;
                try{
                    const resp = await fetch('/api/admin/passengers', { method: 'POST', headers: {'Content-Type':'application/json','X-SESSION': token}, body: JSON.stringify(payload) });
                    const body = await resp.json().catch(()=>({}));
                    if(!resp.ok){ msg.textContent = 'Create failed: '+(body.error||'unknown'); return; }
                    msg.style.color = 'green'; msg.textContent = 'Passenger added';
                    addForm.reset();
                    loadPassengers();
                    setTimeout(()=>{ msg.textContent=''; msg.style.color=''; }, 3000);
                }catch(err){ msg.textContent = 'Request failed'; }
            });
        }

    </script>
    <script>
        // Utility: show inline admin message
        function showMessage(type, text, timeout=4000){
            const el = document.getElementById('adminMessage');
            if(!el) return;
            el.className = '';
            el.classList.add(type === 'error' ? 'error' : 'success');
            el.textContent = text;
            el.style.display = 'block';
            if(timeout>0){
                setTimeout(()=>{ el.style.display='none'; }, timeout);
            }
        }

        // Delete modal handlers
        function openDeleteModal(passport, flight){
            const txt = document.getElementById('deleteConfirmText');
            txt.textContent = `Delete passenger ${passport} on flight ${flight}? This action cannot be undone.`;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.dataset.passport = passport; confirmBtn.dataset.flight = flight;
            document.getElementById('deleteConfirmModal').style.display = 'flex';
            document.getElementById('deleteConfirmModal').setAttribute('aria-hidden','false');
        }
        function closeDeleteModal(){
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.dataset.passport=''; confirmBtn.dataset.flight='';
            document.getElementById('deleteConfirmModal').style.display = 'none';
            document.getElementById('deleteConfirmModal').setAttribute('aria-hidden','true');
        }
        document.getElementById('cancelDeleteBtn').addEventListener('click', ()=> closeDeleteModal());
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function(){
            const passport = this.dataset.passport; const flight = this.dataset.flight;
            try{
                const resp = await fetch('/api/admin/passengers', { method: 'DELETE', headers: {'Content-Type':'application/json','X-SESSION': token}, body: JSON.stringify({ passport: passport, flight: flight }) });
                const body = await resp.json().catch(()=>({}));
                if(!resp.ok){ showMessage('error', 'Delete failed: '+(body.error||'unknown')); closeDeleteModal(); return; }
                showMessage('success', 'Deleted: '+(body.removed||0)+' record(s)');
                closeDeleteModal();
                loadPassengers();
            }catch(err){ showMessage('error', 'Delete request failed'); closeDeleteModal(); }
        });

        // Edit modal handlers
        function openEditModal(passport, flight){
            // find the passenger card to prefill values if present
            const card = document.querySelector(`.passenger-card[data-passport="${passport}"][data-flight="${flight}"]`);
            const nameEl = card ? card.querySelector('.passenger-details h4') : null;
            const infoP = card ? card.querySelector('.passenger-details p') : null;
            const nameVal = nameEl ? nameEl.textContent.trim() : '';
            // try to parse seat/email from details paragraph
            let seatVal = '';
            if(infoP){
                const txt = infoP.textContent || '';
                const seatMatch = txt.match(/Seat:\s*([^\s]+)/i);
                if(seatMatch) seatVal = seatMatch[1];
            }
            document.getElementById('edit_passport').value = passport;
            document.getElementById('edit_flight').value = flight;
            document.getElementById('edit_name').value = nameVal || '';
            document.getElementById('edit_seat').value = seatVal || '';
            document.getElementById('edit_email').value = '';
            document.getElementById('editPassengerModal').style.display = 'flex';
            document.getElementById('editPassengerModal').setAttribute('aria-hidden','false');
        }

        function closeEditModal(){
            document.getElementById('edit_passport').value = '';
            document.getElementById('edit_flight').value = '';
            document.getElementById('edit_name').value = '';
            document.getElementById('edit_seat').value = '';
            document.getElementById('edit_email').value = '';
            document.getElementById('editPassengerModal').style.display = 'none';
            document.getElementById('editPassengerModal').setAttribute('aria-hidden','true');
        }

        // wire modal buttons
        document.getElementById('cancelEditBtn').addEventListener('click', ()=> closeEditModal());
        document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
            const passport = document.getElementById('edit_passport').value;
            const flight = document.getElementById('edit_flight').value;
            const name = document.getElementById('edit_name').value.trim();
            const seat = document.getElementById('edit_seat').value.trim();
            const email = document.getElementById('edit_email').value.trim();
            const payload = { passport: passport, flight: flight };
            if(name) payload.name = name;
            if(seat) payload.seat = seat;
            if(email) payload.email = email;
            if(Object.keys(payload).length <= 2){ showMessage('error','No changes provided'); return; }
            try{
                const resp = await fetch('/api/admin/passengers', { method: 'PUT', headers: {'Content-Type':'application/json','X-SESSION': token}, body: JSON.stringify(payload) });
                const b = await resp.json().catch(()=>({}));
                if(!resp.ok){ showMessage('error','Update failed: '+(b.error||'unknown')); return; }
                showMessage('success','Passenger updated');
                closeEditModal();
                loadPassengers();
            }catch(e){ showMessage('error','Update request failed'); }
        });
    </script>
</body>
</html>